<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Persistent Tasks · Aqua.jl</title><meta name="title" content="Persistent Tasks · Aqua.jl"/><meta property="og:title" content="Persistent Tasks · Aqua.jl"/><meta property="twitter:title" content="Persistent Tasks · Aqua.jl"/><meta name="description" content="Documentation for Aqua.jl."/><meta property="og:description" content="Documentation for Aqua.jl."/><meta property="twitter:description" content="Documentation for Aqua.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script><link href="../assets/favicon.ico" rel="icon" type="image/x-icon"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.svg" alt="Aqua.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">Aqua.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><span class="tocitem">Tests</span><ul><li><a class="tocitem" href="../test_all/">Test everything</a></li><li><a class="tocitem" href="../ambiguities/">Ambiguities</a></li><li><a class="tocitem" href="../unbound_args/">Unbound Type Parameters</a></li><li><a class="tocitem" href="../exports/">Undefined exports</a></li><li><a class="tocitem" href="../project_extras/">Project.toml extras</a></li><li><a class="tocitem" href="../stale_deps/">Stale dependencies</a></li><li><a class="tocitem" href="../deps_compat/">Compat entries</a></li><li><a class="tocitem" href="../piracies/">Type piracy</a></li><li class="is-active"><a class="tocitem" href>Persistent Tasks</a><ul class="internal"><li><a class="tocitem" href="#Motivation"><span>Motivation</span></a></li><li><a class="tocitem" href="#Example"><span>Example</span></a></li><li><a class="tocitem" href="#Checking-for-persistent-tasks"><span>Checking for persistent tasks</span></a></li><li><a class="tocitem" href="#How-the-test-works"><span>How the test works</span></a></li><li><a class="tocitem" href="#How-to-fix-failing-packages"><span>How to fix failing packages</span></a></li><li><a class="tocitem" href="#Additional-information"><span>Additional information</span></a></li><li><a class="tocitem" href="#test_persistent_tasks"><span>Test functions</span></a></li></ul></li></ul></li><li><a class="tocitem" href="../release-notes/">Release notes</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tests</a></li><li class="is-active"><a href>Persistent Tasks</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Persistent Tasks</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/JuliaTesting/Aqua.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/JuliaTesting/Aqua.jl/blob/master/docs/src/persistent_tasks.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Persistent-Tasks"><a class="docs-heading-anchor" href="#Persistent-Tasks">Persistent Tasks</a><a id="Persistent-Tasks-1"></a><a class="docs-heading-anchor-permalink" href="#Persistent-Tasks" title="Permalink"></a></h1><h2 id="Motivation"><a class="docs-heading-anchor" href="#Motivation">Motivation</a><a id="Motivation-1"></a><a class="docs-heading-anchor-permalink" href="#Motivation" title="Permalink"></a></h2><p>Julia 1.10 and higher wait for all running <code>Task</code>s to finish before writing out the precompiled (cached) version of the package. One consequence is that a package that launches <code>Task</code>s in its <code>__init__</code> function may precompile successfully, but block precompilation of any packages that depend on it.</p><p>The symptom of this problem is a message</p><pre><code class="nohighlight hljs">◐ MyPackage: Waiting for background task / IO / timer. Interrupt to inspect...</code></pre><p>that may appear during precompilation, with that precompilation process &quot;hanging&quot; until you press Ctrl-C.</p><p>Aqua has checks to determine whether your package <em>causes</em> this problem. Conversely, if you&#39;re a <em>victim</em> of this problem, it also has tools to help you determine which of your dependencies is causing the problem.</p><h2 id="Example"><a class="docs-heading-anchor" href="#Example">Example</a><a id="Example-1"></a><a class="docs-heading-anchor-permalink" href="#Example" title="Permalink"></a></h2><p>Let&#39;s create a dummy package, <code>PkgA</code>, that launches a persistent <code>Task</code>:</p><pre><code class="language-julia hljs">module PkgA
const t = Ref{Timer}()   # used to prevent the Timer from being garbage-collected
__init__() = t[] = Timer(0.1; interval=1)   # create a persistent `Timer` `Task`
end</code></pre><p><code>PkgA</code> will precompile successfully, because <code>PkgA.__init__()</code> does not run when <code>PkgA</code> is precompiled. However,</p><pre><code class="language-julia hljs">module PkgB
using PkgA
end</code></pre><p>fails to precompile: <code>using PkgA</code> runs <code>PkgA.__init__()</code>, which leaves the <code>Timer</code> <code>Task</code> running, and that causes precompilation of <code>PkgB</code> to hang.</p><p>Without Aqua&#39;s tests, the developers of <code>PkgA</code> might not realize that their package is essentially unusable with any other package.</p><h2 id="Checking-for-persistent-tasks"><a class="docs-heading-anchor" href="#Checking-for-persistent-tasks">Checking for persistent tasks</a><a id="Checking-for-persistent-tasks-1"></a><a class="docs-heading-anchor-permalink" href="#Checking-for-persistent-tasks" title="Permalink"></a></h2><p>Running all of Aqua&#39;s tests will automatically check whether your package falls into this trap. In addition, there are ways to manually run (or tweak) this specific test.</p><h3 id="Manually-running-the-peristent-tasks-check"><a class="docs-heading-anchor" href="#Manually-running-the-peristent-tasks-check">Manually running the peristent-tasks check</a><a id="Manually-running-the-peristent-tasks-check-1"></a><a class="docs-heading-anchor-permalink" href="#Manually-running-the-peristent-tasks-check" title="Permalink"></a></h3><p><a href="#Aqua.test_persistent_tasks"><code>Aqua.test_persistent_tasks(MyPackage)</code></a> will check whether <code>MyPackage</code> blocks precompilation for any packages that depend on it.</p><h3 id="Using-an-expr-to-check-more-than-just-__init__"><a class="docs-heading-anchor" href="#Using-an-expr-to-check-more-than-just-__init__">Using an <code>expr</code> to check more than just <code>__init__</code></a><a id="Using-an-expr-to-check-more-than-just-__init__-1"></a><a class="docs-heading-anchor-permalink" href="#Using-an-expr-to-check-more-than-just-__init__" title="Permalink"></a></h3><p>By default, <code>Aqua.test_persistent_tasks</code> only checks whether a package&#39;s <code>__init__</code> function leaves persistent tasks running. To check whether other package functions leave persistent tasks running, pass a quoted expression:</p><pre><code class="language-julia hljs">Aqua.test_persistent_tasks(MyPackage, quote
    # Code to run after loading MyPackage
    server = MyPackage.start_server()
    MyPackage.stop_server!(server)  # ideally, this this should cleanly shut everything down. Does it?
end)</code></pre><p>Here is an example test with a dummy expr which will obviously fail, because it&#39;s explicitly spawning a Task that never dies.</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; using Aqua</code><code class="nohighlight hljs ansi" style="display:block;"></code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; Aqua.test_persistent_tasks(Aqua, expr = quote
           Threads.@spawn while true sleep(0.5) end
       end)</code><code class="nohighlight hljs ansi" style="display:block;"><span class="sgr91"><span class="sgr1">Test Failed</span></span> at <span class="sgr1">/home/runner/work/Aqua.jl/Aqua.jl/src/persistent_tasks.jl:38</span>
  Expression: !(has_persistent_tasks(package; kwargs...))

ERROR: <span class="sgr91">There was an error during testing</span></code></pre><h2 id="How-the-test-works"><a class="docs-heading-anchor" href="#How-the-test-works">How the test works</a><a id="How-the-test-works-1"></a><a class="docs-heading-anchor-permalink" href="#How-the-test-works" title="Permalink"></a></h2><p>This test works by launching a Julia process that tries to precompile a dummy package similar to <code>PkgB</code> above, modified to signal back to Aqua when <code>PkgA</code> has finished loading. The test fails if the gap between loading <code>PkgA</code> and finishing precompilation exceeds time <code>tmax</code>.</p><h2 id="How-to-fix-failing-packages"><a class="docs-heading-anchor" href="#How-to-fix-failing-packages">How to fix failing packages</a><a id="How-to-fix-failing-packages-1"></a><a class="docs-heading-anchor-permalink" href="#How-to-fix-failing-packages" title="Permalink"></a></h2><p>Often, the easiest fix is to modify the <code>__init__</code> function to check whether the Julia process is precompiling some other package; if so, don&#39;t launch the persistent <code>Task</code>s.</p><pre><code class="language-julia hljs">function __init__()
    # Other setup code here
    if ccall(:jl_generating_output, Cint, ()) == 0   # if we&#39;re not precompiling...
        # launch persistent tasks here
    end
end</code></pre><p>In more complex cases, you may need to modify the task to support a clean shutdown. For example, if you have a <code>Task</code> that runs a never-terminating <code>while</code> loop, you could change</p><pre><code class="nohighlight hljs">    while true
        ⋮
    end</code></pre><p>to</p><pre><code class="nohighlight hljs">    while task_should_run[]
        ⋮
    end</code></pre><p>where</p><pre><code class="nohighlight hljs">const task_should_run = Ref(true)</code></pre><p>is a global constant in your module. Setting <code>task_should_run[] = false</code> from outside that <code>while</code> loop will cause it to terminate on its next iteration, allowing the <code>Task</code> to finish.</p><h2 id="Additional-information"><a class="docs-heading-anchor" href="#Additional-information">Additional information</a><a id="Additional-information-1"></a><a class="docs-heading-anchor-permalink" href="#Additional-information" title="Permalink"></a></h2><p><a href="https://docs.julialang.org/en/v1/devdocs/precompile_hang/">Julia&#39;s devdocs</a> also discuss this issue.</p><h2 id="test_persistent_tasks"><a class="docs-heading-anchor" href="#test_persistent_tasks">Test functions</a><a id="test_persistent_tasks-1"></a><a class="docs-heading-anchor-permalink" href="#test_persistent_tasks" title="Permalink"></a></h2><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Aqua.test_persistent_tasks" href="#Aqua.test_persistent_tasks"><code>Aqua.test_persistent_tasks</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">Aqua.test_persistent_tasks(package)</code></pre><p>Test whether loading <code>package</code> creates persistent <code>Task</code>s which may block precompilation of dependent packages. See also <a href="#Aqua.find_persistent_tasks_deps"><code>Aqua.find_persistent_tasks_deps</code></a>.</p><p>If you provide an optional <code>expr</code>, this tests whether loading <code>package</code> and running <code>expr</code> creates persistent <code>Task</code>s. For example, you might start and shutdown a web server, and this will test that there aren&#39;t any persistent <code>Task</code>s.</p><p>On Julia version 1.9 and before, this test always succeeds.</p><p><strong>Arguments</strong></p><ul><li><code>package</code>: a top-level <code>Module</code> or <code>Base.PkgId</code>.</li></ul><p><strong>Keyword Arguments</strong></p><ul><li><code>broken::Bool = false</code>: If true, it uses <code>@test_broken</code> instead of <code>@test</code>.</li><li><code>tmax::Real = 5</code>: the maximum time (in seconds) to wait after loading the package before forcibly shutting down the precompilation process (triggering a test failure).</li><li><code>expr::Expr = quote end</code>: An expression to run in the precompile package.</li></ul><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p><code>Aqua.test_persistent_tasks(package)</code> creates a package with <code>package</code> as a dependency and runs the precompilation process. This requires that <code>package</code> is instantiable with the information in the <code>Project.toml</code> file alone. In particular, this will not work if some of <code>package</code>&#39;s dependencies are <code>dev</code>ed packages or are given as a local path or a git repository in the <code>Manifest.toml</code>.</p></div></div></div><a class="docs-sourcelink" target="_blank" href="https://github.com/JuliaTesting/Aqua.jl/blob/6ed945762595e3b6258b6aaa02424e9c30a9d4e9/src/persistent_tasks.jl#L1-L33">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Aqua.find_persistent_tasks_deps" href="#Aqua.find_persistent_tasks_deps"><code>Aqua.find_persistent_tasks_deps</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">Aqua.find_persistent_tasks_deps(package; broken = Dict{String,Bool}(), kwargs...)</code></pre><p>Test all the dependencies of <code>package</code> with <a href="#Aqua.test_persistent_tasks"><code>Aqua.test_persistent_tasks</code></a>. On Julia 1.10 and higher, it returns a list of all dependencies failing the test. These are likely the ones blocking precompilation of your package.</p><p>Any additional kwargs (e.g., <code>tmax</code>) are passed to <a href="#Aqua.test_persistent_tasks"><code>Aqua.test_persistent_tasks</code></a>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/JuliaTesting/Aqua.jl/blob/6ed945762595e3b6258b6aaa02424e9c30a9d4e9/src/persistent_tasks.jl#L52-L60">source</a></section></article></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../piracies/">« Type piracy</a><a class="docs-footer-nextpage" href="../release-notes/">Release notes »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.8.0 on <span class="colophon-date" title="Thursday 6 February 2025 12:28">Thursday 6 February 2025</span>. Using Julia version 1.11.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
